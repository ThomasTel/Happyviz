
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>

<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
<script src="datamaps.world.min.js"></script>
<div id="container" style="position: relative; width: 100%; height: 100%;"></div>
<script>
    //CSV reading
    $(document).ready(function() {
        $.get("2015.csv", function (data) {
            processData(data);
        });
    });


    function processData(allText) {
        var allTextLines = allText.split(/\r\n|\n/);
        var headers = allTextLines[0].split(',');
        var countries_datas = {};
        for (var i=1; i<allTextLines.length; i++) {
            var data = allTextLines[i].split(',');
            if (data.length == headers.length) {
                var country = data[0];
                countries_datas[country] = {};
                for (var j=1; j<headers.length; j++) {
                    countries_datas[country][headers[j]] = (j == 1 ? data[j] : parseFloat(data[j]));
                }
            }
        }
        // alert(lines);
        console.log(countries_datas);
        processColoration(countries_datas);
    }
    
    //https://stackoverflow.com/questions/5560248/programmatically-lighten-or-darken-a-hex-color-or-rgb-and-blend-colors
    function shadeColor2(color, percent) {   
        var f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent,R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;
        return "#"+(0x1000000+(Math.round((t-R)*p)+R)*0x10000+(Math.round((t-G)*p)+G)*0x100+(Math.round((t-B)*p)+B)).toString(16).slice(1);
    }
    
    function processColoration(countries_datas)
    {
        var countries_codes = {}
        var countries = Datamap.prototype.worldTopo.objects.world.geometries;
        for (var i = 0; i < countries.length; i++) {
          countries_codes[countries[i].properties.name] = countries[i].id;
        }
        console.log(countries_codes["Australia"]);

        //console.log(countries_datas["Afghanistan"]["Happiness Score"], "yeah");
        
        //console.log(countries_datas["France"]["Happiness Score"], "yeah");
        var colored_countries = {};
        for (var country_name in countries_codes) {
          //console.log(country_name);
          if(country_name in countries_datas && "Happiness Score" in countries_datas[country_name])
          {
            var happiness = countries_datas[country_name]["Happiness Score"];
            //console.log(happiness, shadeColor2('#3f83a3', happiness/10));
            colored_countries[countries_codes[country_name]] = shadeColor2('#3f83a3', happiness/10);
            //console.log(country_name, countries_datas[country_name]["Happiness Score"]);
          }
        }
        console.log(colored_countries);
        map.updateChoropleth(colored_countries);
    }
    
    //DataMaps
    var map = new Datamap({
    element: document.getElementById('container'),
    /*fills: {
          defaultFill: '#f0af0a',
          lt50: shadeColor2('#3f83a3', 0),
          gt50: 'red'
        },
    data: {
          USA: {fillKey: 'gt50' },
          RUS: {fillKey: 'lt50' },
          CAN: {fillKey: 'lt50' },
          BRA: {fillKey: 'gt50' },
          ARG: {fillKey: 'gt50'},
          COL: {fillKey: 'gt50' },
          AUS: {fillKey: 'gt50' },
          ZAF: {fillKey: 'gt50' },
          MAD: {fillKey: 'gt50' }       
        }
    }*/
    //data: colored_countries
    });
    
</script>
<style>
body {
    background-color: lightblue;
}
</style>